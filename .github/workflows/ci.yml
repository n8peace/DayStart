name: CI/CD Pipeline

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop, main ]

env:
  SUPABASE_DEVELOP_PROJECT: ${{ secrets.SUPABASE_DEVELOP_PROJECT }}
  SUPABASE_MAIN_PROJECT: ${{ secrets.SUPABASE_MAIN_PROJECT }}

jobs:
  # iOS App CI (Disabled for now - focus on backend first)
  ios-ci:
    name: iOS Build & Test (Skipped)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Skip iOS Build
      run: |
        echo "iOS builds disabled - focusing on backend development first"
        echo "Will enable when iOS app development begins"
        
  # Supabase CI
  supabase-ci:
    name: Supabase Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
        
    - name: Validate Supabase Config
      run: |
        cd supabase
        supabase --version
        
    - name: Validate Migration Files
      run: |
        cd supabase
        echo "Validating migration files..."
        for file in migrations/*.sql; do
          if [ -f "$file" ]; then
            echo "Checking $file"
            # Basic SQL syntax validation
            if ! grep -q "CREATE TABLE\|ALTER TABLE\|DROP TABLE\|CREATE INDEX\|CREATE POLICY" "$file"; then
              echo "Warning: $file doesn't contain expected SQL statements"
            fi
          fi
        done
        echo "âœ… Migration files validated"
        
  # Deploy to Develop (on develop branch) - DISABLED: Using Supabase native integration
  deploy-develop:
    name: Deploy to Develop Environment (DISABLED)
    runs-on: ubuntu-latest
    if: false  # Disabled - using Supabase native GitHub integration
    needs: [ios-ci, supabase-ci]
    environment: develop
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
        
    - name: Deploy to Supabase Develop (DISABLED)
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      run: |
        echo "ðŸš« Supabase deployment disabled - using native GitHub integration"
        echo "âœ… Supabase will automatically deploy from GitHub integration"
        echo "ðŸ“‹ Check Supabase Dashboard â†’ Settings â†’ GitHub for deployment status"
        
    - name: Notify Deploy Success
      run: |
        echo "âœ… Supabase native integration enabled"
        echo "ðŸ“‹ Check Supabase Dashboard â†’ Settings â†’ GitHub for deployment status"
        echo "ðŸ”— Project: ${{ env.SUPABASE_DEVELOP_PROJECT }}"
        
  # Deploy to Production (manual trigger only)
  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [ios-ci, supabase-ci]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
        
    - name: Deploy to Supabase Production
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      run: |
        cd supabase
        echo "Linking to production project: ${{ env.SUPABASE_MAIN_PROJECT }}"
        supabase link --project-ref ${{ env.SUPABASE_MAIN_PROJECT }}
        echo "Deploying database migrations..."
        supabase db push --db-url ${{ secrets.SUPABASE_MAIN_DB_URL }}
        echo "Deploying edge functions..."
        supabase functions deploy
        
    - name: Notify Deploy Success
      run: |
        echo "âœ… Successfully deployed to production environment"
        echo "Project: ${{ env.SUPABASE_MAIN_PROJECT }}"
        
  # Security & Quality Checks
  security-checks:
    name: Security & Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for secrets in code
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        
    - name: Check for large files
      run: |
        find . -type f -size +10M -not -path "./.git/*" | head -10
        
    - name: Validate file structure
      run: |
        echo "Checking project structure..."
        test -f README.md || exit 1
        test -f .env.example || exit 1
        test -d supabase || exit 1
        echo "âœ… Project structure is valid"
