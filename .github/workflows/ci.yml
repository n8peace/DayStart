name: CI/CD Pipeline

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop, main ]

env:
  SUPABASE_DEVELOP_PROJECT: ${{ secrets.SUPABASE_DEVELOP_PROJECT }}
  SUPABASE_MAIN_PROJECT: ${{ secrets.SUPABASE_MAIN_PROJECT }}

jobs:
  # iOS App CI (Disabled for now - focus on backend first)
  ios-ci:
    name: iOS Build & Test (Skipped)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Skip iOS Build
      run: |
        echo "iOS builds disabled - focusing on backend development first"
        echo "Will enable when iOS app development begins"
        
  # Supabase CI
  supabase-ci:
    name: Supabase Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
        
    - name: Validate Supabase Config
      run: |
        cd supabase
        supabase --version
        
    - name: Validate Migration Files
      run: |
        cd supabase
        echo "Validating migration files..."
        for file in migrations/*.sql; do
          if [ -f "$file" ]; then
            echo "Checking $file"
            # Basic SQL syntax validation
            if ! grep -q "CREATE TABLE\|ALTER TABLE\|DROP TABLE\|CREATE INDEX\|CREATE POLICY" "$file"; then
              echo "Warning: $file doesn't contain expected SQL statements"
            fi
          fi
        done
        echo "‚úÖ Migration files validated"
        
  # Deploy to Develop (on develop branch)
  deploy-develop:
    name: Deploy to Develop Environment
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    needs: [ios-ci, supabase-ci]
    environment: develop
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
        
    - name: Deploy to Supabase Develop
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      run: |
        cd supabase
        echo "üîç Checking if database URL is available..."
        if [ -z "${{ secrets.SUPABASE_DEVELOP_DB_URL }}" ]; then
          echo "‚ùå SUPABASE_DEVELOP_DB_URL secret is not set"
          exit 1
        fi
        echo "‚úÖ Database URL is available"
        
        echo "üåê Forcing IPv4 connections..."
        export GODEBUG=netdns=go
        
        echo "üîç Testing network connectivity..."
        echo "Database URL format: $(echo ${{ secrets.SUPABASE_DEVELOP_DB_URL }} | cut -d'@' -f2 | cut -d'/' -f1)"
        
        echo "Deploying database migrations using direct database URL..."
        supabase db push --db-url ${{ secrets.SUPABASE_DEVELOP_DB_URL }} --dns-resolver https --debug
        echo "Deploying edge functions..."
        supabase functions deploy --project-ref ${{ env.SUPABASE_DEVELOP_PROJECT }}
        
    - name: Notify Deploy Success
      run: |
        echo "‚úÖ Successfully deployed to develop environment"
        echo "Project: ${{ env.SUPABASE_DEVELOP_PROJECT }}"
        
  # Deploy to Production (manual trigger only)
  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [ios-ci, supabase-ci]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
        
    - name: Deploy to Supabase Production
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      run: |
        cd supabase
        echo "Linking to production project: ${{ env.SUPABASE_MAIN_PROJECT }}"
        supabase link --project-ref ${{ env.SUPABASE_MAIN_PROJECT }}
        echo "Deploying database migrations..."
        supabase db push --db-url ${{ secrets.SUPABASE_MAIN_DB_URL }}
        echo "Deploying edge functions..."
        supabase functions deploy
        
    - name: Notify Deploy Success
      run: |
        echo "‚úÖ Successfully deployed to production environment"
        echo "Project: ${{ env.SUPABASE_MAIN_PROJECT }}"
        
  # Security & Quality Checks
  security-checks:
    name: Security & Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for secrets in code
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        
    - name: Check for large files
      run: |
        find . -type f -size +10M -not -path "./.git/*" | head -10
        
    - name: Validate file structure
      run: |
        echo "Checking project structure..."
        test -f README.md || exit 1
        test -f .env.example || exit 1
        test -d supabase || exit 1
        echo "‚úÖ Project structure is valid"
